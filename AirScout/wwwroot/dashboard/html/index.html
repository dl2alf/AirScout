<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Tell the browser to be responsive to screen width -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="keywords"
          content="wrappixel, admin dashboard, html css dashboard, web dashboard, bootstrap 5 admin, bootstrap 5, css3 dashboard, bootstrap 5 dashboard, Matrix lite admin bootstrap 5 dashboard, frontend, responsive bootstrap 5 admin template, Matrix admin lite design, Matrix admin lite dashboard bootstrap 5 dashboard template" />
    <meta name="description"
          content="Welcome to AirScout dashboard" />
    <meta name="robots" content="noindex,nofollow" />
    <title>Welcome to AirScout dashboard</title>
    <!-- Favicon icon -->
    <link rel="icon"
          type="image/png"
          sizes="16x16"
          href="../assets/images/favicon.png" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="/../../leaflet/leaflet.css" />
    <!-- Custom CSS -->
    <link href="../assets/libs/flot/css/float-chart.css" rel="stylesheet" />
    <!-- Custom CSS -->
    <link href="../dist/css/style.min.css" rel="stylesheet" />
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

  <body>
    <!-- ============================================================== -->
    <!-- Preloader - style you can find in spinners.css -->
    <!-- ============================================================== -->
    <div class="preloader">
      <div class="lds-ripple">
        <div class="lds-pos"></div>
        <div class="lds-pos"></div>
      </div>
    </div>
    <!-- ============================================================== -->
    <!-- Main wrapper - style you can find in pages.scss -->
    <!-- ============================================================== -->
    <div id="main-wrapper"
         data-layout="vertical"
         data-navbarbg="skin5"
         data-sidebartype="full"
         data-sidebar-position="absolute"
         data-header-position="absolute"
         data-boxed-layout="full">
        <!-- ============================================================== -->
        <!-- Topbar header - style you can find in pages.scss -->
        <!-- ============================================================== -->
        <header class="topbar" data-navbarbg="skin5">
            <nav class="navbar top-navbar navbar-expand-md navbar-dark">
                <div class="navbar-header" data-logobg="skin5">
                    <!-- ============================================================== -->
                    <!-- Logo -->
                    <!-- ============================================================== -->
                    <a class="navbar-brand" href="index.html">
                        <!-- Logo icon -->
                        <b class="logo-icon ps-2">
                            <!--You can put here icon as well // <i class="wi wi-sunset"></i> //-->
                            <!-- Dark Logo icon -->
                            <img src="../assets/images/logo-icon.png"
                                 alt="homepage"
                                 class="light-logo"
                                 width="25" />
                        </b>
                        <!--End Logo icon -->
                        <!-- Logo text -->
                        <span class="logo-text ms-2">
                            <!-- dark Logo text -->
                            <img src="../assets/images/logo-text.png"
                                 alt="homepage"
                                 class="light-logo" />
                        </span>
                        <!-- Logo icon -->
                        <!-- <b class="logo-icon"> -->
                        <!--You can put here icon as well // <i class="wi wi-sunset"></i> //-->
                        <!-- Dark Logo icon -->
                        <!-- <img src="../assets/images/logo-text.png" alt="homepage" class="light-logo" /> -->
                        <!-- </b> -->
                        <!--End Logo icon -->
                    </a>
                    <!-- ============================================================== -->
                    <!-- End Logo -->
                    <!-- ============================================================== -->
                    <!-- ============================================================== -->
                    <!-- Toggle which is visible on mobile only -->
                    <!-- ============================================================== -->
                    <a class="nav-toggler waves-effect waves-light d-block d-md-none"
                       href="javascript:void(0)">
                        <i class="ti-menu ti-close"></i>
                    </a>
                </div>
                <!-- ============================================================== -->
                <!-- End Logo -->
                <!-- ============================================================== -->
                <div class="navbar-collapse collapse"
                     id="navbarSupportedContent"
                     data-navbarbg="skin5">
                    <!-- ============================================================== -->
                    <!-- toggle and nav items -->
                    <!-- ============================================================== -->
                    <ul class="navbar-nav float-start me-auto">
                        <li class="nav-item d-none d-lg-block">
                            <a class="nav-link sidebartoggler waves-effect waves-light"
                               href="javascript:void(0)"
                               data-sidebartype="mini-sidebar">
                                <i class="mdi mdi-menu font-24"></i>
                            </a>
                        </li>
                    </ul>
                     <div class="nav pull-right">
                        <!-- ============================================================== -->
                        <!-- Pause button -->
                        <!-- ============================================================== -->
                        <button type="button" class="btn btn-warning d-flex
                                    align-items-center
                                    justify-content-center" aria-label="Left Align" id="pause">
                            <span class="glyphicon glyphicon-pause" aria-hidden="true">Pause</span>
                        </button>
                        &nbsp;&nbsp;&nbsp;
                        <!-- ============================================================== -->
                        <!-- Play button -->
                        <!-- ============================================================== -->
                        <button type="button" class="btn btn-success d-flex
                                    align-items-center
                                    justify-content-center" aria-label="Left Align" id="play">
                            <span class="glyphicon glyphicon-pause" aria-hidden="true">Play</span>
                        </button>
                    </div>
                <!-- ============================================================== -->
                <!-- Right side toggle and nav items -->
                <!-- ============================================================== -->
                <ul class="navbar-nav float-end">
                    <!-- ============================================================== -->
                    <!-- User profile and search -->
                    <!-- ============================================================== -->
                    <li class="nav-item dropdown">
                        <a class="
                    nav-link
                    dropdown-toggle
                    text-muted
                    waves-effect waves-dark
                    pro-pic
                  "
                           href="#"
                           id="navbarDropdown"
                           role="button"
                           data-bs-toggle="dropdown"
                           aria-expanded="false">
                            <img src="../assets/images/users/1.jpg"
                                 alt="user"
                                 class="rounded-circle"
                                 width="31" />
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end user-dd animated"
                            aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="javascript:void(0)"><i class="mdi mdi-account me-1 ms-1"></i> My Profile</a>
                            <a class="dropdown-item" href="javascript:void(0)"><i class="mdi mdi-wallet me-1 ms-1"></i> My Balance</a>
                            <a class="dropdown-item" href="javascript:void(0)"><i class="mdi mdi-email me-1 ms-1"></i> Inbox</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="javascript:void(0)">
                                <i class="mdi mdi-settings me-1 ms-1"></i> Account
                                Setting
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="javascript:void(0)"><i class="fa fa-power-off me-1 ms-1"></i> Logout</a>
                            <div class="dropdown-divider"></div>
                            <div class="ps-4 p-10">
                                <a href="javascript:void(0)"
                                   class="btn btn-sm btn-success btn-rounded text-white">View Profile</a>
                            </div>
                        </ul>
                    </li>
                    <!-- ============================================================== -->
                    <!-- User profile and search -->
                    <!-- ============================================================== -->
                </ul>
</div>
            </nav>
        </header>
        <!-- ============================================================== -->
        <!-- End Topbar header -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        <!-- Left Sidebar - style you can find in sidebar.scss  -->
        <!-- ============================================================== -->
        <aside class="left-sidebar" data-sidebarbg="skin5">
            <!-- Sidebar scroll-->
            <div class="scroll-sidebar">
                <!-- Sidebar navigation-->
                <nav class="sidebar-nav">
                    <table style="width:95%">
                        <tr><td style="width:5%"> </td><td class="label" style="width:25%">UTC:</td><td style="width:5%"> </td><td style="width:65%"><input class="utc" style="width:100%" id="utc" value="0000-00-00 00:00:00" readonly /></td></tr>
                        <tr><td style="width:5%"> </td><td class="label" style="width:25%">Band:</td><td style="width:5%"> </td><td style="width:65%"><select style="width:100%" id="band"></select></td></tr>
                        <tr><td style="width:5%"> </td><td class="label" style="width:25%">MyCall:</td><td style="width:5%"> </td><td style="width:65%"><input style="width:100%" id="mycall" maxlength="14" /></td></tr>
                        <tr><td style="width:5%"> </td><td class="label" style="width:25%">MyLoc:</td><td style="width:5%"> </td><td style="width:65%"><input style="width:100%" id="myloc" maxlength="14" /></td></tr>
                        <tr><td style="width:5%"> </td><td class="label" style="width:25%">DXCall:</td><td style="width:5%"> </td><td style="width:65%"><input style="width:100%" id="dxcall" maxlength="14" /></td></tr>
                        <tr><td style="width:5%"> </td><td class="label" style="width:25%">DXLoc:</td><td style="width:5%"> </td><td style="width:65%"><input style="width:100%" id="dxloc" maxlength="14" /></td></tr>
                    </table>
                </nav>
                <!-- End Sidebar navigation -->
            </div>
            <!-- End Sidebar scroll-->
        </aside>
        <!-- ============================================================== -->
        <!-- End Left Sidebar - style you can find in sidebar.scss  -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        <!-- Page wrapper  -->
        <!-- ============================================================== -->
        <div class="page-wrapper">
            <!-- ============================================================== -->
            <!-- Container fluid  -->
            <!-- ============================================================== -->
            <div class="container-fluid">
                <!-- ============================================================== -->
                <!-- Sales Cards  -->
                <!-- ============================================================== -->
                <div class="row">
                    <!-- Column -->
                    <!-- ============================================================== -->
                    <!-- Sales chart -->
                    <!-- ============================================================== -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-body">
                                    <div id="map" style="height:800px"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ============================================================== -->
                    <!-- Sales chart -->
                    <!-- ============================================================== -->
                </div>
                <!-- ============================================================== -->
                <!-- End Container fluid  -->
                <!-- ============================================================== -->
                <!-- ============================================================== -->
                <!-- footer -->
                <!-- ============================================================== -->
                <footer class="footer text-center">
                    AirScout dashoard (c) DL2ALF, based on free Matrix-admin dashboard layout by
                    <a href="https://www.wrappixel.com">WrapPixel</a>.
                </footer>
                <!-- ============================================================== -->
                <!-- End footer -->
                <!-- ============================================================== -->
            </div>
            <!-- ============================================================== -->
            <!-- End Page wrapper  -->
            <!-- ============================================================== -->
        </div>
        <!-- ============================================================== -->
        <!-- End Wrapper -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        <!-- All Jquery -->
        <!-- ============================================================== -->
        <script src="../assets/libs/jquery/dist/jquery.min.js"></script>
        <!-- Bootstrap tether Core JavaScript -->
        <script src="../assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
        <script src="../assets/libs/perfect-scrollbar/dist/perfect-scrollbar.jquery.min.js"></script>
        <script src="../assets/extra-libs/sparkline/sparkline.js"></script>
        <!--Wave Effects -->
        <script src="../dist/js/waves.js"></script>
        <!--Menu sidebar -->
        <script src="../dist/js/sidebarmenu.js"></script>
        <!--Custom JavaScript -->
        <script src="../dist/js/custom.min.js"></script>
        <!--This page JavaScript -->
        <!-- <script src="../dist/js/pages/dashboards/dashboard1.js"></script> -->
        <!-- Charts js Files -->
        <script src="../assets/libs/flot/excanvas.js"></script>
        <script src="../assets/libs/flot/jquery.flot.js"></script>
        <script src="../assets/libs/flot/jquery.flot.pie.js"></script>
        <script src="../assets/libs/flot/jquery.flot.time.js"></script>
        <script src="../assets/libs/flot/jquery.flot.stack.js"></script>
        <script src="../assets/libs/flot/jquery.flot.crosshair.js"></script>
        <script src="../assets/libs/flot.tooltip/js/jquery.flot.tooltip.min.js"></script>
        <script src="../dist/js/pages/chart/chart-page-init.js"></script>
        <!-- Leaflet js Files -->
        <script src="/../../leaflet/leaflet.js"></script>
        <script src="/../../leaflet/leaflet.rotatedMarker.js"></script>


        <!-- ============================================================== -->
        <!-- All AirScout related JavaScript                                -->
        <!-- ============================================================== -->
        <!-- ScoutBase js Files -->
        <script src="/../../resources/js/scoutbase.core.js"></script>
        <!-- AirScout js Files -->
        <script src="/../../resources/js/airscout.core.js"></script>

        <script>

            // global variables

            var rooturl = "http://localhost:9880";

            var map = null;

            var lay_paths = null;
            var lay_planes = null;

            var bands = null;
            var band = null;

            var planes = null;
            var selectedplanes = null;

            var mycall = null;
            var myloc = null;
            var mylat = null;
            var mylon = null;
            var dxcall = null;
            var dxloc = null;
            var dxlat = null;
            var dxlon = null;

            var play = false;

            // start refresh timer
            setInterval(timerTick, 1000);

            $(document).ready(function () {

                // get available bands
                bands = AirScout.getBands(rooturl);

                // get cookies, if any
                band = SupportFunctions.getCookie("band");
                $("#band").val(band);

                mycall = SupportFunctions.getCookie("mycall");
                myloc = SupportFunctions.getCookie("myloc");
                mylat = SupportFunctions.getCookie("mylat");
                mylon = SupportFunctions.getCookie("mylon");
                $("#mycall").val(mycall);
                $("#myloc").val(myloc);

                dxcall = SupportFunctions.getCookie("dxcall");
                dxloc = SupportFunctions.getCookie("dxloc");
                dxlat = SupportFunctions.getCookie("dxlat");
                dxlon = SupportFunctions.getCookie("dxlon");
                $("#dxcall").val(dxcall);
                $("#dxloc").val(dxloc);

                // fill bands drop down and select band
                if (bands != null) {
                    try {
                        $.each(bands, function (i, item) {
                            $('#band').append($('<option>', {
                                value: item,
                                text: item
                            }));
                        });
                    }
                    catch (e) {
                        console.error(e.message);
                    }

                }
                $("#band").val(band).change();


                map = L.map('map').setView([51.505, -0.09], 10);
                L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);

                lay_paths = L.layerGroup([]).addTo(map);
                lay_planes = L.layerGroup([]).addTo(map);
            });

            $("#pause").click(function () {
                Pause();
            });

            $("#play").click(function () {
                Play();
            });

            $('#band').on('change', function () {
                band = this.value;
                document.cookie = "band=" + band + "; max-age=2147483647; path=/"
            });

             function timerTick() {
                if (!play)
                    return;

                getPlanes();

                drawPlanes();
             }

            function clearAllLayers() {

                lay_paths.clearLayers();
                lay_planes.clearLayers();

            }

            function Play() {

                $("#band").prop('disabled', true);
                $("#mycall").prop('disabled', true);
                $("#myloc").prop('disabled', true);
                $("#dxcall").prop('disabled', true);
                $("#dxloc").prop('disabled', true);

                drawPath();

                play = true;

            }

            function Pause() {

                play = false;
                clearAllLayers();
                $("#band").prop('disabled', false);
                $("#mycall").prop('disabled', false);
                $("#myloc").prop('disabled', false);
                $("#dxcall").prop('disabled', false);
                $("#dxloc").prop('disabled', false);
            }

            function markerOnClick(e) {
                alert("hi. you clicked the marker at " + e.latlng);
            }

            // draws the propagation path
            function drawPath() {

                if ((mycall == null) || (myloc == null) || (mylat == null) || (mylon == null) || (dxcall == null) || (dxloc == null) || (dxlat == null) || (dxlon == null))
                    return;

                try {

                    var ppath = AirScout.getPropagationPath(rooturl, mycall, myloc, dxcall, dxloc);

                    if (ppath == null)
                        return;

                    // store cookies
                    document.cookie = "mycall=" + mycall + "; max-age=2147483647; path=/"
                    document.cookie = "myloc=" + myloc + "; max-age=2147483647; path=/"
                    document.cookie = "mylat=" + mylat + "; max-age=2147483647; path=/"
                    document.cookie = "mylon=" + mylon + "; max-age=2147483647; path=/"

                    document.cookie = "dxcall=" + dxcall + "; max-age=2147483647; path=/"
                    document.cookie = "dxloc=" + dxloc + "; max-age=2147483647; path=/"
                    document.cookie = "dxlat=" + dxlat + "; max-age=2147483647; path=/"
                    document.cookie = "dxlon=" + dxlon + "; max-age=2147483647; path=/"

                    var redIcon = new L.Icon({
                        iconUrl: '/../../leaflet/images/marker-icon-red.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                    var yellowIcon = new L.Icon({
                        iconUrl: '/../../leaflet/images/marker-icon-yellow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });

                    var mymarker = L.marker([mylat, mylon], { icon: redIcon }).addTo(lay_paths);
                    mymarker.bindTooltip(mycall);
                    var dxmarker = L.marker([dxlat, dxlon], { icon: yellowIcon }).addTo(lay_paths);
                    dxmarker.bindTooltip(dxcall);

                    // get 1km-waypoints from from path
                    var infopoints = Propagation.GetInfoPoints(ppath);

                    // create path
                    var ppoints = [];
                    for (var i = 0; i < infopoints.length; i++) {

                        ppoints.push(new Array(infopoints[i].Lat, infopoints[i].Lon));
                    }
                    var ppath = L.polyline(ppoints, { color: "black" }).addTo(lay_paths);

                    // create visible path
                    var vpoints = [];
                    for (var i = 0; i < infopoints.length; i++) {

                        if ((Math.max(infopoints[i].H1, infopoints[i].H2) > 0) && (Math.max(infopoints[i].H1, infopoints[i].H2) < 12000)) {
                            vpoints.push(new Array(infopoints[i].Lat, infopoints[i].Lon));
                        }
                    }
                    var vpath = L.polyline(vpoints, { color: "magenta" }).addTo(lay_paths);

                    // zoom map to fit rect
                    map.fitBounds(ppath.getBounds());

                }
                catch (e) {
                }
            }

            function getPlanes() {

                // get nearest planes
                planes = AirScout.getNearestPlanes(rooturl, mycall, myloc, dxcall, dxloc, $("#band").val());
            }

            function drawPlanes() {

                if ((planes == null) || (planes.length == 0))
                    return;

                if ((map == null) || (mycall == null) || (myloc == null) || (mylat == null) || (mylon == null) || (dxcall == null) || (dxloc == null) || (dxlat == null) || (dxlon == null))
                    return;

                // update time
                var now = new Date();
                var today = now.getUTCFullYear().toString().padStart(4, '0') + "-" +
                    now.getUTCMonth().toString().padStart(2, '0') + "-" +
                    now.getUTCDay().toString().padStart(2, '0') + " " +
                    now.getUTCHours().toString().padStart(2, '0') + ":" +
                    now.getUTCMinutes().toString().padStart(2, '0') + ":" +
                    now.getUTCSeconds().toString().padStart(2, '0');
                $("#utc").val(today);

                try {

                    lay_planes.clearLayers();

                    for (i = 0; i < planes.length; i++) {

                        var color = (planes[i]['Potential'] == 100) ? "magenta" : (planes[i]['Potential'] == 75) ? "red" : (planes[i]['Potential'] == 50) ? "darkorange" : "gray";
                        var size = (planes[i]['Category'] == 4) ? [48, 48] : (planes[i]['Category'] == 3) ? [32, 32] : (planes[i]['Category'] == 2) ? [24, 24] : (planes[i]['Category'] == 1) ? [16, 16] : [24, 24];
                        var cat = (planes[i]['Category'] == 4) ? "S" : (planes[i]['Category'] == 3) ? "H" : (planes[i]['Category'] == 2) ? "M" : (planes[i]['Category'] == 1) ? "L" : "N";

                        var picon = new L.Icon({
                            iconUrl: "/../../resources/icons/plane_" + color + ".png",
                            iconSize: size,
                            iconAnchor: [size[0] / 2, size[1] / 2]
                        });
                        var pmarker = L.marker([planes[i]['Lat'], planes[i]['Lon']], { icon: picon, rotationAngle: planes[i]['Track'] }).on('click', markerOnClick).addTo(lay_planes);
                        var lat = (lat >= 0) ? planes[i]['Lat'].toFixed(2) + "°N" : planes[i]['Lat'].toFixed(2) + "°S";
                        var lon = (lon >= 0) ? planes[i]['Lon'].toFixed(2) + "°E" : planes[i]['Lon'].toFixed(2) + "°W";
                        var alt = planes[i]['Alt_m'].toFixed(0) + "m";
                        var track = planes[i]['Track'].toFixed(0) + "°";
                        pmarker.bindTooltip(
                            planes[i]['Call'] +
                            "<br>-----------<br>Pos: " +
                            lat +
                            " , " +
                            lon +
                            "<br>Alt: " +
                            alt +
                            "<br>Track: " +
                            track +
                            "<br>Type: " + planes[i].Manufacturer + " " + planes[i].Model + " [" + cat + "]",
                            { className: 'leaflet-tooltip-plane-' + color }
                        );
                    }

                }
                catch (e) {
                    console.error(e.message);
                }
            }

            $("#mycall").on("input", function (e) {
                var input = $(this);
                var val = input.val();
                var location = AirScout.getLocation(rooturl, val);

                if (location == null) {

                    mylat = null;
                    mylon = null;
                    $("#myloc").val("");

                    return;
                }

                try {

                    mycall = response.Call;
                    myloc = response.Loc;
                    mylat = response.Lat;
                    mylon = response.Lon;
                    $("#myloc").val(myloc);
                    $("#mycall").val(mycall);

                }
                catch (e) {
                    cons.error(e.message);
                    mylat = null;
                    mylon = null;
                    $("#myloc").val("");
                }
            });

            $("#dxcall").on("input", function (e) {
                var input = $(this);
                var val = input.val();

                var location = AirScout.getLocation(rooturl, val);

                if (location == null) {

                    dxlat = null;
                    dxlon = null;
                    $("#dxloc").val("");

                    return;
                }


                try {

                    dxcall = response.Call;
                    dxloc = response.Loc;
                    dxlat = response.Lat;
                    dxlon = response.Lon;
                    $("#dxloc").val(dxloc);
                    $("#dxcall").val(dxcall);

                }
                catch (e) {
                    cons.error(e.message);
                    dxlat = null;
                    dxlon = null;
                    $("#dxloc").val("");
                }
            });


        </script>

</body>
</html>
